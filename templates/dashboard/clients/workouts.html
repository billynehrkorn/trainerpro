{% extends "base.html" %}

{% block title %}{{ client.name }} - Workouts - TrainerPro{% endblock %}

{% block content %}
<div class="p-4 lg:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">{{ client.name }} - Workouts</h1>
                <p class="text-gray-600 mt-2">Complete workout history and details</p>
            </div>
            <a href="{{ url_for('new_workout', client_id=client.id) }}"
               class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                <i class="fas fa-plus mr-2"></i>Log Workout
            </a>
        </div>

        {% if workouts %}
            <div class="space-y-4">
                {% for workout in workouts %}
                <!-- Compacted workout container with edit functionality -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 workout-date" data-date="{{ workout.workout_date }}">{{ workout.workout_date }}</h3>
                                <p class="text-gray-600 text-sm">{{ workout.exercise_count }} exercises</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="editWorkout('{{ client.id }}', '{{ workout.workout_date }}')"
                                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm font-medium">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <!-- Added delete button with proper styling -->
                                <button onclick="deleteWorkout('{{ client.id }}', '{{ workout.workout_date }}')"
                                        class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm font-medium">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>

                        <div class="workout-exercises" data-client-id="{{ client.id }}" data-workout-date="{{ workout.workout_date }}">
                            <div class="text-center py-2">
                                <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                <span class="text-gray-500 ml-2">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <i class="fas fa-dumbbell text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No workouts logged yet</h3>
                <p class="text-gray-600 mb-4">Start tracking {{ client.name }}'s fitness journey.</p>
                <a href="{{ url_for('new_workout', client_id=client.id) }}"
                   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium inline-flex items-center">
                    <i class="fas fa-plus mr-2"></i>Log First Workout
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Updated edit workout modal to match new_workout.html interface exactly -->
<div id="editWorkoutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Edit Workout</h2>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="editWorkoutContent" class="p-6">
                <!-- Edit form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function formatWorkoutDates() {
    const workoutDates = document.querySelectorAll('.workout-date');
    workoutDates.forEach(element => {
        const dateStr = element.getAttribute('data-date');
        if (dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            const formattedDate = date.toLocaleDateString('en-US', options);
            const dayNum = date.getDate();
            let suffix = 'th';
            if (dayNum % 10 === 1 && dayNum !== 11) suffix = 'st';
            else if (dayNum % 10 === 2 && dayNum !== 12) suffix = 'nd';
            else if (dayNum % 10 === 3 && dayNum !== 13) suffix = 'rd';

            element.textContent = formattedDate.replace(/(\d+),/, `$1${suffix},`);
        }
    });
}

async function loadWorkoutDetails() {
    const workoutContainers = document.querySelectorAll('.workout-exercises');

    for (const container of workoutContainers) {
        const clientId = container.getAttribute('data-client-id');
        const workoutDate = container.getAttribute('data-workout-date');

        try {
            const response = await fetch(`/api/workout-details/${clientId}/${workoutDate}`);
            if (response.ok) {
                const exercises = await response.json();
                displayWorkoutExercises(container, exercises);
            } else {
                container.innerHTML = '<p class="text-red-500 text-center">Error loading workout details</p>';
            }
        } catch (error) {
            console.error('Error loading workout:', error);
            container.innerHTML = '<p class="text-red-500 text-center">Error loading workout details</p>';
        }
    }
}

function displayWorkoutExercises(container, exercises) {
    if (!exercises || exercises.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-2">No exercises found</p>';
        return;
    }

    let html = '<div class="space-y-3">';

    exercises.forEach((exercise, index) => {
        html += `
            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                <h4 class="font-medium text-gray-900 mb-2">${exercise.exercise_name}</h4>

                <!-- Display individual sets instead of set counter -->
                <div class="space-y-1 mb-2">
        `;

        // Parse sets data - handle both individual sets and legacy format
        let setsData = [];
        if (exercise.sets_data && Array.isArray(exercise.sets_data)) {
            setsData = exercise.sets_data;
        } else {
            // Legacy format - create sets from single values
            const setCount = exercise.sets || 1;
            for (let i = 0; i < setCount; i++) {
                setsData.push({
                    weight: exercise.weight,
                    reps: exercise.reps
                });
            }
        }

        setsData.forEach((set, setIndex) => {
            html += `
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-600 w-12">Set ${setIndex + 1}:</span>
                    <span class="bg-white px-2 py-1 rounded border text-gray-700">
                        ${set.weight ? set.weight + ' lbs' : 'N/A'}
                    </span>
                    <span class="text-gray-400">×</span>
                    <span class="bg-white px-2 py-1 rounded border text-gray-700">
                        ${set.reps || 'N/A'} reps
                    </span>
                </div>
            `;
        });

        html += `
                </div>
                ${exercise.notes ? `<p class="text-sm text-gray-600 italic">"${exercise.notes}"</p>` : ''}
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

async function editWorkout(clientId, workoutDate) {
    try {
        const response = await fetch(`/api/workout-details/${clientId}/${workoutDate}`);
        if (response.ok) {
            const exercises = await response.json();
            showEditModal(clientId, workoutDate, exercises);
        } else {
            alert('Error loading workout for editing');
        }
    } catch (error) {
        console.error('Error loading workout for edit:', error);
        alert('Error loading workout for editing');
    }
}

function showEditModal(clientId, workoutDate, exercises) {
    const modal = document.getElementById('editWorkoutModal');
    const content = document.getElementById('editWorkoutContent');

    let html = `
        <form id="editWorkoutForm" onsubmit="updateWorkout(event, '${clientId}', '${workoutDate}')">
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Workout Date</label>
                <input type="date" value="${workoutDate}" class="w-full p-2 border border-gray-300 rounded-lg" readonly>
            </div>

            <div id="editExercisesList" class="space-y-6">
    `;

    exercises.forEach((exercise, index) => {
        // Parse sets data for editing
        let setsData = [];
        if (exercise.sets_data && Array.isArray(exercise.sets_data)) {
            setsData = exercise.sets_data;
        } else {
            // Legacy format - create sets from single values
            const setCount = exercise.sets || 1;
            for (let i = 0; i < setCount; i++) {
                setsData.push({
                    weight: exercise.weight || '',
                    reps: exercise.reps || ''
                });
            }
        }

        html += `
            <div class="exercise-row p-4 border border-gray-200 rounded-lg" data-exercise-index="${index}">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Exercise ${index + 1}</h3>
                    <button type="button" onclick="removeExercise(this)" class="text-red-600 hover:text-red-800 ${exercises.length === 1 ? 'hidden' : ''}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Exercise Name</label>
                    <div class="relative">
                        <input type="text" name="exercise_name[]" value="${exercise.exercise_name}"
                               class="exercise-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Start typing exercise name..." required>
                        <div class="exercise-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1"></div>
                    </div>
                </div>

                <!-- Updated sets container to use exercise-specific field names -->
                <div class="sets-container mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Sets</label>
                        <button type="button" onclick="addSet(this)" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-plus"></i> Add Set
                        </button>
                    </div>
                    <div class="sets-list">
        `;

        setsData.forEach((set, setIndex) => {
            html += `
                        <div class="set-row flex items-center gap-2 mb-2">
                            <span class="text-sm font-medium text-gray-600 w-12">Set ${setIndex + 1}:</span>
                            <input type="number" name="exercise_${index}_weight[]" step="0.5" min="0" placeholder="Weight" value="${set.weight || ''}"
                                   class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <span class="text-xs text-gray-500">lbs</span>
                            <input type="number" name="exercise_${index}_reps[]" min="1" placeholder="Reps" value="${set.reps || ''}"
                                   class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <span class="text-xs text-gray-500">reps</span>
                            <button type="button" onclick="removeSet(this)" class="text-red-500 hover:text-red-700 text-sm ${setsData.length === 1 ? 'hidden' : ''}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
            `;
        });

        html += `
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea name="exercise_notes[]" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Optional notes for this exercise...">${exercise.notes || ''}</textarea>
                </div>

                <input type="hidden" name="exercise_id[]" value="${exercise.id}">
            </div>
        `;
    });

    html += `
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mb-6">
                <button type="button" onclick="addExercise()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium">
                    <i class="fas fa-plus mr-2"></i>Add Exercise
                </button>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium">
                    Update Workout
                </button>
                <button type="button" onclick="closeEditModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium">
                    Cancel
                </button>
            </div>
        </form>
    `;

    content.innerHTML = html;
    modal.classList.remove('hidden');

    // Setup autocomplete for existing inputs
    const exerciseInputs = content.querySelectorAll('.exercise-input');
    exerciseInputs.forEach(input => setupExerciseAutocomplete(input));
}

function closeEditModal() {
    document.getElementById('editWorkoutModal').classList.add('hidden');
}

let exerciseCount = 0;

function addExercise() {
    const exercisesList = document.getElementById('editExercisesList');
    exerciseCount = exercisesList.children.length;

    const exerciseHtml = `
        <div class="exercise-row p-4 border border-gray-200 rounded-lg" data-exercise-index="${exerciseCount}">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Exercise ${exerciseCount + 1}</h3>
                <button type="button" onclick="removeExercise(this)" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Exercise Name</label>
                <div class="relative">
                    <input type="text" name="exercise_name[]"
                           class="exercise-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Start typing exercise name..." required>
                    <div class="exercise-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1"></div>
                </div>
            </div>

            <div class="sets-container mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">Sets</label>
                    <button type="button" onclick="addSet(this)" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
                        <i class="fas fa-plus"></i> Add Set
                    </button>
                </div>
                <div class="sets-list">
                    <div class="set-row flex items-center gap-2 mb-2">
                        <span class="text-sm font-medium text-gray-600 w-12">Set 1:</span>
                        <input type="number" name="exercise_${exerciseCount}_weight[]" step="0.5" min="0" placeholder="Weight"
                               class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <span class="text-xs text-gray-500">lbs</span>
                        <input type="number" name="exercise_${exerciseCount}_reps[]" min="1" placeholder="Reps"
                               class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <span class="text-xs text-gray-500">reps</span>
                        <button type="button" onclick="removeSet(this)" class="text-red-500 hover:text-red-700 text-sm hidden">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                <textarea name="exercise_notes[]" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Optional notes for this exercise..."></textarea>
            </div>

            <input type="hidden" name="exercise_id[]" value="">
        </div>
    `;

    exercisesList.insertAdjacentHTML('beforeend', exerciseHtml);

    // Setup autocomplete for the new input
    const newInput = exercisesList.lastElementChild.querySelector('.exercise-input');
    setupExerciseAutocomplete(newInput);

    updateRemoveButtons();
}

function setupExerciseAutocomplete(input) {
    const suggestionsDiv = input.nextElementSibling;
    let debounceTimer;

    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 2) {
            suggestionsDiv.classList.add('hidden');
            return;
        }

        debounceTimer = setTimeout(async () => {
            try {
                const response = await fetch(`/api/exercises/search?q=${encodeURIComponent(query)}`);
                const exercises = await response.json();

                if (exercises.length > 0) {
                    suggestionsDiv.innerHTML = exercises.map(exercise =>
                        `<div class="exercise-suggestion p-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" data-name="${exercise.name}">
                            <div class="font-medium">${exercise.name}</div>
                            <div class="text-sm text-gray-600">${exercise.muscle_group} • ${exercise.equipment}</div>
                        </div>`
                    ).join('');
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching exercises:', error);
                suggestionsDiv.classList.add('hidden');
            }
        }, 300);
    });

    suggestionsDiv.addEventListener('click', function(e) {
        const suggestion = e.target.closest('.exercise-suggestion');
        if (suggestion) {
            input.value = suggestion.dataset.name;
            suggestionsDiv.classList.add('hidden');
        }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.classList.add('hidden');
        }
    });
}

function addSet(button) {
    const setsContainer = button.closest('.sets-container');
    const exerciseRow = button.closest('.exercise-row');
    const exerciseIndex = exerciseRow.getAttribute('data-exercise-index');
    const setsList = setsContainer.querySelector('.sets-list');
    const setCount = setsList.children.length + 1;

    const setRow = document.createElement('div');
    setRow.className = 'set-row flex items-center gap-2 mb-2';
    setRow.innerHTML = `
        <span class="text-sm font-medium text-gray-600 w-12">Set ${setCount}:</span>
        <input type="number" name="exercise_${exerciseIndex}_weight[]" step="0.5" min="0" placeholder="Weight"
               class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <span class="text-xs text-gray-500">lbs</span>
        <input type="number" name="exercise_${exerciseIndex}_reps[]" min="1" placeholder="Reps"
               class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <span class="text-xs text-gray-500">reps</span>
        <button type="button" onclick="removeSet(this)" class="text-red-500 hover:text-red-700 text-sm">
            <i class="fas fa-times"></i>
        </button>
    `;

    setsList.appendChild(setRow);
    updateSetNumbers(setsContainer);
    updateSetRemoveButtons(setsContainer);
}

function removeSet(button) {
    const setsContainer = button.closest('.sets-container');
    button.closest('.set-row').remove();
    updateSetNumbers(setsContainer);
    updateSetRemoveButtons(setsContainer);
}

function updateSetNumbers(setsContainer) {
    const setRows = setsContainer.querySelectorAll('.set-row');
    setRows.forEach((row, index) => {
        row.querySelector('span').textContent = `Set ${index + 1}:`;
    });
}

function updateSetRemoveButtons(setsContainer) {
    const removeButtons = setsContainer.querySelectorAll('.set-row button[onclick*="removeSet"]');
    removeButtons.forEach(button => {
        if (removeButtons.length === 1) {
            button.classList.add('hidden');
        } else {
            button.classList.remove('hidden');
        }
    });
}

function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('.exercise-row button[onclick*="removeExercise"]');
    removeButtons.forEach(button => {
        if (removeButtons.length === 1) {
            button.classList.add('hidden');
        } else {
            button.classList.remove('hidden');
        }
    });
}

function updateExerciseNumbers() {
    const exercises = document.querySelectorAll('.exercise-row h3');
    exercises.forEach((h3, index) => {
        h3.textContent = `Exercise ${index + 1}`;
    });
}

async function updateWorkout(event, clientId, workoutDate) {
    event.preventDefault();

    const formData = new FormData(event.target);

    try {
        const response = await fetch(`/api/update-workout/${clientId}/${workoutDate}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            closeEditModal();
            location.reload(); // Refresh to show updated workout
        } else {
            alert('Error updating workout');
        }
    } catch (error) {
        console.error('Error updating workout:', error);
        alert('Error updating workout');
    }
}

async function deleteWorkout(clientId, workoutDate) {
    if (!confirm('Are you sure you want to delete this entire workout? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/delete-workout/${clientId}/${workoutDate}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload(); // Refresh to show updated workout list
        } else {
            alert('Error deleting workout');
        }
    } catch (error) {
        console.error('Error deleting workout:', error);
        alert('Error deleting workout');
    }
}

function removeExercise(button) {
    const exercisesList = document.getElementById('editExercisesList');
    button.closest('.exercise-row').remove();

    const exercises = exercisesList.querySelectorAll('.exercise-row');
    exercises.forEach((exercise, newIndex) => {
        exercise.setAttribute('data-exercise-index', newIndex);

        // Update field names for sets
        const weightInputs = exercise.querySelectorAll('input[name*="_weight"]');
        const repsInputs = exercise.querySelectorAll('input[name*="_reps"]');

        weightInputs.forEach(input => {
            input.name = `exercise_${newIndex}_weight[]`;
        });

        repsInputs.forEach(input => {
            input.name = `exercise_${newIndex}_reps[]`;
        });
    });

    // Update exercise numbers
    updateExerciseNumbers();
    updateRemoveButtons();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    formatWorkoutDates();
    loadWorkoutDetails();
});
</script>
{% endblock %}
