{% extends "base.html" %}

{% block title %}{{ client.name }} - Weight Logs - TrainerPro{% endblock %}

{% block content %}
<div class="p-4 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
            <div class="flex items-center mb-4 lg:mb-0">
                <a href="{{ url_for('client_detail', client_id=client.id) }}" 
                   class="text-blue-600 hover:text-blue-800 mr-4">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">{{ client.name }} - Weight Logs</h1>
                    <p class="text-gray-600">Track weight progress over time</p>
                </div>
            </div>
            <button onclick="openWeightModal()"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">
                <i class="fas fa-plus mr-2"></i>Add Weight Entry
            </button>
        </div>

        <!-- Weight Logs Content -->
        <div class="bg-white rounded-lg shadow p-6">
            {% if weight_history %}
                <div class="space-y-3">
                    {% for entry in weight_history %}
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-weight text-purple-600"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-lg text-gray-900">{{ entry.weight }} lbs</p>
                                <p class="text-sm text-gray-600 weight-date" data-date="{{ entry.date }}">{{ entry.date }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            {% if entry.notes %}
                            <div class="text-right">
                                <p class="text-sm text-gray-700 italic">"{{ entry.notes }}"</p>
                            </div>
                            {% endif %}
                            <!-- Added edit and delete icons -->
                            <div class="flex items-center space-x-2">
                                <button onclick="editWeightEntry('{{ entry.id }}', '{{ entry.date }}', '{{ entry.weight }}', '{{ entry.notes or '' }}')"
                                        class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-colors"
                                        title="Edit weight entry">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button onclick="deleteWeightEntry('{{ entry.id }}')"
                                        class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition-colors"
                                        title="Delete weight entry">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-weight text-gray-300 text-6xl mb-4"></i>
                    <h3 class="text-xl font-medium text-gray-900 mb-2">No weight entries yet</h3>
                    <p class="text-gray-600 mb-6">Start tracking {{ client.name }}'s weight progress</p>
                    <button onclick="openWeightModal()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">
                        <i class="fas fa-plus mr-2"></i>Add First Weight Entry
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Weight Modal -->
<div id="weightModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Add Weight Entry</h3>
            <button onclick="closeWeightModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="weightForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="weightDate" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Weight (lbs)</label>
                    <input type="number" id="weightValue" step="0.1" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                    <textarea id="weightNotes" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                              placeholder="Any additional notes about this weight entry..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md font-medium">
                    Save Weight
                </button>
                <button type="button" onclick="closeWeightModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Weight Modal -->
<div id="editWeightModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Edit Weight Entry</h3>
            <button onclick="closeEditWeightModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editWeightForm">
            <input type="hidden" id="editWeightId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="editWeightDate" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Weight (lbs)</label>
                    <input type="number" id="editWeightValue" step="0.1" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                    <textarea id="editWeightNotes" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                              placeholder="Any additional notes about this weight entry..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md font-medium">
                    Update Weight
                </button>
                <button type="button" onclick="closeEditWeightModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function formatDates() {
    // Format weight dates
    document.querySelectorAll('.weight-date').forEach(element => {
        const dateStr = element.getAttribute('data-date');
        if (dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', options);
            const dayNum = date.getDate();
            let suffix = 'th';
            if (dayNum % 10 === 1 && dayNum !== 11) suffix = 'st';
            else if (dayNum % 10 === 2 && dayNum !== 12) suffix = 'nd';
            else if (dayNum % 10 === 3 && dayNum !== 13) suffix = 'rd';
            element.textContent = formattedDate.replace(/(\d+),/, `$1${suffix},`);
        }
    });
}

function openWeightModal() {
    document.getElementById('weightModal').classList.remove('hidden');
    document.getElementById('weightModal').classList.add('flex');
    document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
}

function closeWeightModal() {
    document.getElementById('weightModal').classList.add('hidden');
    document.getElementById('weightModal').classList.remove('flex');
    document.getElementById('weightForm').reset();
}

function editWeightEntry(id, date, weight, notes) {
    document.getElementById('editWeightId').value = id;
    document.getElementById('editWeightDate').value = date;
    document.getElementById('editWeightValue').value = weight;
    document.getElementById('editWeightNotes').value = notes;

    document.getElementById('editWeightModal').classList.remove('hidden');
    document.getElementById('editWeightModal').classList.add('flex');
}

function closeEditWeightModal() {
    document.getElementById('editWeightModal').classList.add('hidden');
    document.getElementById('editWeightModal').classList.remove('flex');
    document.getElementById('editWeightForm').reset();
}

function deleteWeightEntry(id) {
    if (confirm('Are you sure you want to delete this weight entry?')) {
        fetch(`/api/weight-log/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting weight entry. Please try again.');
            }
        })
        .catch(error => {
            alert('Error deleting weight entry. Please try again.');
        });
    }
}

document.getElementById('weightForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = {
        client_id: '{{ client.id }}',
        date: document.getElementById('weightDate').value,
        weight: parseFloat(document.getElementById('weightValue').value),
        notes: document.getElementById('weightNotes').value
    };

    try {
        const response = await fetch('/api/weight-log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            closeWeightModal();
            location.reload();
        } else {
            alert('Error logging weight. Please try again.');
        }
    } catch (error) {
        alert('Error logging weight. Please try again.');
    }
});

document.getElementById('editWeightForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = {
        date: document.getElementById('editWeightDate').value,
        weight: parseFloat(document.getElementById('editWeightValue').value),
        notes: document.getElementById('editWeightNotes').value
    };

    const id = document.getElementById('editWeightId').value;

    try {
        const response = await fetch(`/api/weight-log/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            closeEditWeightModal();
            location.reload();
        } else {
            alert('Error updating weight entry. Please try again.');
        }
    } catch (error) {
        alert('Error updating weight entry. Please try again.');
    }
});

// Initialize date formatting when page loads
document.addEventListener('DOMContentLoaded', formatDates);
</script>
{% endblock %}
